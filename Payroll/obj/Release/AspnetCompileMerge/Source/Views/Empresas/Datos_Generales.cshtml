<div class="container bg-white pb-3 rounded font-labels">
    <div class="d-flex justify-content-between">
        <div class="h4 px-5 py-3 font-button " style="font-size:14px;">Datos generales de la empresa</div>

        <div class="collapsed" data-toggle="collapse" data-target="#collapseAddEmpresa" aria-expanded="false" aria-controls="collapseAddEmpresa">
            <div class="d-flex justify-content-end ">
                <div class="btn btn-link pr-1 btnadd font-labels" id="btnadd" href="#inNombre_Empresa">
                    Agregar empresa <i class='text-success fas fa-plus-circle'></i>
                </div>       
            </div>
        </div>
    </div>
    <div class="col-md-12 p-3 m-0 form-group row rounded" style="background-color:#E8EAF6;color:black;">
            <label class="font-weight-bold col-md-2 py-0">Id Empresa : </label>
            <label class="text-left col-md-4 py-0" id="l-01"></label>
            <label class="font-weight-bold col-md-2 py-0">Nombre corto : </label>
            <label class="text-left col-md-4 py-0" id="l-02"></label>
            <label class="font-weight-bold col-md-2">Razón Social : </label>
            <label class="text-left col-md-4" id="l-03"></label>
            <label class="font-weight-bold col-md-2">Codigo Postal : </label>
            <label class="text-left col-md-4" id="l-04"></label>
            <label class="font-weight-bold col-md-2">Estado : </label>
            <label class="text-left col-md-4" id="l-05"></label>
            <label class="font-weight-bold col-md-2">Cuidad : </label>
            <label class="text-left col-md-4" id="l-06"></label>
            <label class="font-weight-bold col-md-2">Delegacion : </label>
            <label class="text-left col-md-4" id="l-07"></label>
            <label class="font-weight-bold col-md-2">Colonia : </label>
            <label class="text-left col-md-4" id="l-08"></label>
            <label class="font-weight-bold col-md-2">Calle : </label>
            <label class="text-left col-md-4" id="l-09"></label>
            <label class="font-weight-bold col-md-2">Giro : </label>
            <label class="text-left col-md-4" id="l-10"></label>
            <label class="font-weight-bold col-md-2">RFC : </label>
            <label class="text-left col-md-4" id="l-11"></label>
            <label class="font-weight-bold col-md-2">Fecha alta : </label>
            <label class="text-left col-md-4" id="l-12"></label>
            <label class="font-weight-bold col-md-2">Regimen Fiscal : </label>
            <label class="text-left col-md-4" id="l-13"></label>
            <div class="col-md-6 font-labels d-flex justify-content-end" ><div id="btnEditarEmpresa" class="btn btn-outline-success font-weight-bold" style="font-size:12px;">Editar  <i class="pl-1 far fa-edit"></i> </div></div>
    </div>
    <div class="dropdown-divider mb-3"></div>
    <div class="">

    </div>
    <div class="accordion" id="accordionExample">
        <div class=" col-md-12">
            
            <div id="collapseAddEmpresa" class="collapse" aria-labelledby="headingThree" data-parent="#accordionExample">
                <div class="col-md-12">
                    Agregar datos de la nueva empresa
                </div>
                <div class="dropdown-divider mb-3"></div>
                <form id="form_inEmpresa" class="needs-validation font-labels" novalidate>
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="inNombre_empresa" class=" col-form-label font-labels">Nombre Empresa</label>
                            <input class="form-control font-labels" type="text" name="inNombre_empresa" id="inNombre_empresa" placeholder="Escribe la razón social de la empresa" required>
                            <div class="invalid-feedback">
                                Ingrese la razon social de la empresa
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="inNomCorto_empresa" class="col-form-label font-labels">Nombre Corto</label>
                            <input type="text" class="form-control font-labels" name="inNomCorto_empresa" id="inNomCorto_empresa" placeholder="Escribe el nombre corto de la empresa" required>
                            <div class="valid-feedback">

                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="inRfc_empresa">RFC de la empresa</label>
                            <input type="text" class="form-control font-labels" name="inRfc_empresa" id="inRfc_empresa" placeholder="Escribe en RFC de la empresa" maxlength="12" required>
                            <div class="valid-feedback">

                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="inGiro_empresa">Giro de la empresa</label>
                            <input type="text" class="form-control font-labels" name="inGiro_empresa" id="inGiro_empresa" placeholder="Escribe en giro de la empresa" required>
                            <div class="valid-feedback">

                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="inGiro_empresa">Regimen Fiscal</label>
                            <select type="text" class="form-control font-labels" name="inRFiscal_empresa" id="inRFiscal_empresa" required>
                            </select>
                            <div class="valid-feedback">

                            </div>
                        </div>
                        <div class="h5 px-5 py-3 text-dark font-labels col-md-12"><span class="fas fa-circle"></span> Direccion de la empresa</div>
                        <div class="dropdown-divider mb-3"></div>
                        <div class="form-group col-md-2">
                            <label for="inCodigo_postal">Codigo Postal</label>
                            <input type="text" maxlength="5" size="5" class="form-control input-number font-labels" min="0" name="inCodigo_postal" id="inCodigo_postal" required>
                            <div class="invalid-feedback">
                            </div>
                        </div>
                        <div class="form-group col-md-2">
                            <label for="">Validar CP</label>
                            <button class="form-control btn btn-secondary font-button font-labels" type="button" id="btnValidaCpEstado">
                                &nbsp;Valida CP
                            </button>
                        </div>
                        <div class="form-group col-md-5">
                            <label for="inEstado_empresa">Estado</label>
                            <select class="form-control custom-select font-labels" name="inEstado_empresa" id="inEstado_empresa" required>
                            </select>
                            <div class="invalid-feedback">

                            </div>
                        </div>

                        <div class="form-group col-md-3">
                            <label for="inDelegacion_empresa">Municipio</label>
                            <select class="form-control custom-select font-labels" name="inMunicipio_empresa" id="inMunicipio_empresa">
                            </select>
                            <div class="valid-feedback">

                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="inCiudad_empresa">Cuidad</label>
                            <select class="form-control custom-select font-labels" name="inCiudad_empresa" id="inCiudad_empresa" required>
                            </select>
                            <div class="invalid-feedback">

                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="inColonia_empresa">Colonia</label>
                            <select class="form-control  custom-select font-labels" name="inColonia_empresa" id="inColonia_empresa" required>
                                <option value="">Selecciona</option>
                            </select>
                            <div class="valid-feedback">

                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="inCalle_Empresa">Delegacion</label>
                            <input class="form-control font-labels" type="text" name="inDelegacion_Empresa" id="inDelegacion_Empresa" value="" placeholder="Ingrese la delegación" autocomplete="off" required />
                            <div class="invalid-feedback">

                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="inCalle_Empresa">Calle</label>
                            <input class="form-control font-labels" type="text" name="inCalle_Empresa" id="inCalle_Empresa" placeholder="Ingrese la calle" autocomplete="off" required />
                            <div class="invalid-feedback">

                            </div>
                        </div>
                        <div class="form-group col-md-12">
                            <div class="h5 px-5 pt-3 text-dark font-labels"><span class="fas fa-circle"></span> Asignar Registro Patronal</div>

                        </div>
                        <div class="col-md-12" id="feedback_rg"></div>
                        <div class="form-gruop col-md-6">
                            <div class="form-group">
                                <label for="inAfiliacionIMSS">Afiliacion IMSS</label>
                                <input type="text" class="form-control" id="inAfiliacionIMSS" maxlength="12" placeholder="Ingresa en Numero de afiliación al IMSS" required>
                                <div class="invalid-feedback">

                                </div>
                            </div>
                        </div>
                        <div class="form-gruop col-md-6">
                            <div class="form-group">
                                <label for="inNombreAfiliacionIMSS">Nombre Afiliacion</label>
                                <input type="text" class="form-control" id="inNombreAfiliacionIMSS" placeholder="Ingresa en Nombre de la afiliación al IMSS" required>
                                <div class="invalid-feedback">

                                </div>
                            </div>
                        </div>
                        <div class="form-gruop col-md-6">
                            <div class="form-group">
                                <label for="inRiesgoTrabajo">Riesgo de trabajo</label>
                                <input type="text" class="form-control" id="inRiesgoTrabajo" placeholder="Ingresa el riesgo de trabajo" required>
                                <div class="invalid-feedback">

                                </div>
                            </div>
                        </div>
                        <div class="form-gruop col-md-6">
                            <div class="form-group">
                                <label for="inClase">Clase </label>
                                <select class="form-control custom-select font-labels" id="inClase" required>
                                    <option value="">Selecciona</option>
                                </select>
                                <div class="invalid-feedback">

                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-12 row m-0">
                            <div class="form-group col-md-4">
                                <input class="btn btn-primary form-control font-button" type="submit" name="btn_saveEmpresa" id="btn_saveEmpresa" value="Guardar Empresa" />
                            </div>
                            <div class="form-group col-md-4">
                                <div id="btnClear" class="btn btn-warning btn-sm form-control"><i class="far fa-trash-alt"></i> Limpiar</div>
                            </div>
                            <div class="form-group col-md-4">
                                <div id="btnUpdate" class="btn btn-success btn-sm form-control"><i class="fas fa-edit"></i> Actualizar</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
</div>

<script>
    // patron del RFC, persona moral
    _rfc_pattern_pm = "^(([A-ZÑ&]{3})([0-9]{2})([0][13578]|[1][02])(([0][1-9]|[12][\\d])|[3][01])([A-Z0-9]{3}))|" +
        "(([A-ZÑ&]{3})([0-9]{2})([0][13456789]|[1][012])(([0][1-9]|[12][\\d])|[3][0])([A-Z0-9]{3}))|" +
        "(([A-ZÑ&]{3})([02468][048]|[13579][26])[0][2]([0][1-9]|[12][\\d])([A-Z0-9]{3}))|" +
        "(([A-ZÑ&]{3})([0-9]{2})[0][2]([0][1-9]|[1][0-9]|[2][0-8])([A-Z0-9]{3}))$";
    // patron del RFC, persona fisica
    _rfc_pattern_pf = "^(([A-ZÑ&]{4})([0-9]{2})([0][13578]|[1][02])(([0][1-9]|[12][\\d])|[3][01])([A-Z0-9]{3}))|" +
        "(([A-ZÑ&]{4})([0-9]{2})([0][13456789]|[1][012])(([0][1-9]|[12][\\d])|[3][0])([A-Z0-9]{3}))|" +
        "(([A-ZÑ&]{4})([02468][048]|[13579][26])[0][2]([0][1-9]|[12][\\d])([A-Z0-9]{3}))|" +
        "(([A-ZÑ&]{4})([0-9]{2})[0][2]([0][1-9]|[1][0-9]|[2][0-8])([A-Z0-9]{3}))$";
    //
    var codpost = document.getElementById('inCodigo_postal');
    var city = document.getElementById('inCiudad_empresa');
    var colony = document.getElementById('inColonia_empresa');
    var municipio = document.getElementById("inMunicipio_empresa");
    var states = document.getElementById("inEstado_empresa");
    var btnvalidacpstate = document.getElementById("btnValidaCpEstado");
    $(document).ready(function () {
        btnvalidacpstate.disabled = true;
        city.disabled = true;
        municipio.disabled = true;
        states.disabled = true;
        colony.disabled = true;
        $("#btnValidaCpEstado").on("click", function () {
            fvalidatestatecodpost();
        });
        fvalidatestatecodpost = () => {
            if (codpost.value.length === 5) {
                setTimeout(() => {
                    $.ajax({
                        url: "../Empleados/LoadInformationHome2",
                        type: "POST",
                        data: { codepost: codpost.value },

                        success: (data) => {
                            console.log(data);
                            if (data.length > 0) {
                                city.disabled = false;
                                municipio.disabled = false;
                                colony.disabled = false;
                                states.disabled = false;
                                $("#inColonia_empresa").empty();
                                for (i = 0; i < data.length; i++) {
                                    if (data[i].sColonia != "") {
                                        colony.innerHTML += `<option value='${data[i].iIdColonia}'>${data[i].sColonia}</option>`;
                                        municipio.innerHTML = `<option value='${data[i].iIdMunicipio}' >${data[i].sMunicipio}</option>`;
                                        states.innerHTML = `<option value='${data[i].iIdEstado}' >${data[i].sEstado}</option>`;
                                        city.innerHTML = `<option value='${data[i].sCiudad}'>${data[i].sCiudad}</option>`;

                                    }
                                }
                                setTimeout(() => {
                                    colony.focus();
                                }, 500);
                            } else {
                                Swal.fire({
                                    title: "Atención",
                                    text: "El código postal ingresado es incorrecto",
                                    icon: "warning",
                                    showClass: { popup: 'animated fadeInDown faster' },
                                    hideClass: { popup: 'animated fadeOutUp faster' },
                                    confirmButtonText: "Aceptar", allowOutsideClick: false, allowEscapeKey: false, allowEnterKey: false,
                                }).then((acepta) => {
                                    setTimeout(() => { codpost.focus(); }, 800)
                                });
                            }
                        }, error: (jqXHR, exception) => {
                            fcaptureaerrorsajax(jqXHR, exception);
                        }
                    });
                }, 1500);
            } else {
                Swal.fire({
                    title: "Atención", text: "El código postal debe de contener 5 caracteres", icon: "warning",
                    showClass: { popup: 'animated fadeInDown faster' },
                    hideClass: { popup: 'animated fadeOutUp faster' },
                    confirmButtonText: "Aceptar", allowOutsideClick: false, allowEscapeKey: false, allowEnterKey: false,
                }).then((acepta) => {

                    setTimeout(() => { codpost.focus(); }, 800);
                });
            }
        }
    });
    document.getElementById("btnClear").classList.add("invisible");
    document.getElementById("btnUpdate").classList.add("invisible");
    $("#inCodigo_postal").on("keyup", function (evt) {
        var i = $(this).val();
        if (i.length == 5) {
            btnvalidacpstate.disabled = false;
            $("#btnValidaCpEstado").removeClass("btn-secondary");
            $("#btnValidaCpEstado").addClass("btn-info");
        } else {
            btnvalidacpstate.disabled = true;
            $("#btnValidaCpEstado").removeClass("btn-info");
            $("#btnValidaCpEstado").addClass("btn-secondary");
        }
    });
    $("#inRfc_empresa").on("keyup", function (evt) {
        var rfc = $("#inRfc_empresa").val();
        if (rfc.length === 12) {
            ValidaRFC();
        } else {
            if ($("#inRfc_empresa").hasClass("is-invalid")) { }
            else { $("#inRfc_empresa").addClass("is-invalid"); }
        }
        function ValidaRFC() {
            if (rfc.match(_rfc_pattern_pm)) {
                $("#inRfc_empresa").removeClass("is-invalid");
                $("#inRfc_empresa").addClass("is-valid");
                return true;
            } else {
                $("#inRfc_empresa").removeClass("is-valid");
                $("#inRfc_empresa").addClass("is-invalid");
                return false;
            }
        }
    });
    $('.input-number').on('input', function () {
        this.value = this.value.replace(/[^0-9]/g, '');
    });
    $.ajax({
        url: "../Empresas/LoadDatosEmpresa",
        type: "POST",
        contentType: "application/json; charset=utf-8",
        success: (data) => {
            console.log("datos empresa");
            console.log(data);
            document.getElementById("l-01").innerHTML = data[0];
            document.getElementById("l-02").innerHTML = data[1];
            document.getElementById("l-03").innerHTML = data[2];
            document.getElementById("l-04").innerHTML = data[3];
            document.getElementById("l-05").innerHTML = data[4];
            document.getElementById("l-06").innerHTML = data[5];
            document.getElementById("l-07").innerHTML = data[6];
            document.getElementById("l-08").innerHTML = data[7];
            document.getElementById("l-09").innerHTML = data[8];
            document.getElementById("l-10").innerHTML = data[9];
            document.getElementById("l-11").innerHTML = data[10];
            document.getElementById("l-12").innerHTML = data[11].substring(0,10);
            document.getElementById("l-13").innerHTML = data[12];
        }
    });
    $.ajax({
        url: "../Empresas/LoadClasesRP",
        type: "POST",
        data: JSON.stringify(),
        contentType: "application/json; charset=utf-8",
        success: (data) => {
            console.log(data);
            for (i = 0; i < data.length; i++) {
                document.getElementById("inClase").innerHTML += `<option value='${data[i].IdClase}'>${data[i].Nombre_Clase}</option>`;
            }
        }
    });
    $.ajax({
        url: "../Empresas/LoadRegimenesFiscales",
        type: "POST",
        data: JSON.stringify(),
        contentType: "application/json; charset=utf-8",
        success: (data) => {
            console.log(data);
            for (i = 0; i < data.length; i++) {
                document.getElementById("inRFiscal_empresa").innerHTML += `<option value='${data[i].IdRegimenFiscal}'>${data[i].Descripcion}</option>`;
            }
        }
    });

    $("#form_inEmpresa").submit(function (evt) {

        var emp = document.getElementById("form_inEmpresa");
        if (emp.checkValidity() === false) {
            evt.preventDefault();
            evt.stopPropagation();
            emp.classList.add("was-validated");
            setTimeout(function () {
                $("#form_inEmpresa").removeClass("was-validated");
            }, 5000);
        } else {
            evt.preventDefault();
            evt.stopPropagation();

            var nomEmp = document.getElementById("inNombre_empresa");
            var nomEmpc = document.getElementById("inNomCorto_empresa");
            var rfcemp = document.getElementById("inRfc_empresa");
            var giroEmp = document.getElementById("inGiro_empresa");
            var cpEmp = document.getElementById("inCodigo_postal");
            var estEmp = document.getElementById("inEstado_empresa");
            var munEmp = document.getElementById("inMunicipio_empresa");
            var ciuEmp = document.getElementById("inCiudad_empresa");
            var colEmp = document.getElementById("inColonia_empresa");
            var delEmp = document.getElementById("inDelegacion_Empresa");
            var callEmp = document.getElementById("inCalle_Empresa");
            var rfEmp = document.getElementById("inRFiscal_empresa");
            var noafiEmp = document.getElementById("inNombreAfiliacionIMSS");
            var afImss = document.getElementById("inAfiliacionIMSS");
            var riesgot = document.getElementById("inRiesgoTrabajo");
            var claserp = document.getElementById("inClase");
            var datos = {
                inNombre_empresa: nomEmp.value
                , inNomCorto_empresa: nomEmpc.value
                , inRfc_empresa: rfcemp.value
                , inGiro_empresa: giroEmp.value
                , inRegimenFiscal_Empresa: rfEmp.value
                , inCodigo_postal: cpEmp.value
                , inEstado_empresa: estEmp.value
                , inMunicipio_empresa: munEmp.value
                , inCiudad_empresa: ciuEmp.value
                , inColonia_empresa: colEmp.value
                , inDelegacion_Empresa: delEmp.value
                , inCalle_Empresa: callEmp.value
                , inAfiliacionIMSS: afImss.value
                , inNombre_Afiliacion: noafiEmp.value
                , inRiesgoTrabajo: riesgot.value
                , inClase: claserp.value
            };
            console.log(datos);
            $.ajax({
                url: "../Empresas/Insert_Empresa_FirstStep",
                type: "POST",
                data: JSON.stringify(datos),
                contentType: "application/json; charset=utf-8",
                success: (data) => {
                    console.log(data);
                    if (data[0] == "True") {
                        Swal.fire({
                            icon: 'success',
                            title: 'Correcto!',
                            text: 'Empresa agregada con exito!'
                        }, false).then(() => {

                            setTimeout(function () {
                                emp.reset();
                                $("#bodySubmenus").load("/Empresas/Registros_Patronales");
                            }, 1500);
                        });
                    } else if (data[0] == "False") {
                        Swal.fire({
                            icon: 'error',
                            title: '',
                            text: '' + data[1]
                        }, false).then(() => {
                            nom.focus();
                            nom.classList.add("is-invalid");
                            rfc.classList.add("is-invalid");
                            setTimeout(function () {
                                nom.classList.remove("is-invalid");
                                rfc.classList.remove("is-invalid");
                            }, 5500);
                        });
                    }

                }
            });
        }
    });

    $(".collapse").on("show", function () {
        //document.getElementById("btnadd").innerHTML = "Ocultar agregar empresa";
        console.log("show");
        $("#inNombre_empresa").focus();
        document.getElementById("inNombre_empresa").focus();
    });
    $("#btnadd").on("click", function () {
        document.getElementById("btnadd").innerHTML = "Ocultar agregar empresa <i class='text-danger fas fa-minus-circle'></i>";
        console.log("show");
        
    });
    $('#collapseAddEmpresa').on('hidden.bs.collapse', function () {
        document.getElementById("btnadd").innerHTML = "Agregar empresa <i class='text-success fas fa-plus-circle'></i>";
        console.log("was hide");
    });

    $("#btnEditarEmpresa").on("click", function () {
        var nomEmp = document.getElementById("inNombre_empresa");
        var nomEmpc = document.getElementById("inNomCorto_empresa");
        var rfcemp = document.getElementById("inRfc_empresa");
        var giroEmp = document.getElementById("inGiro_empresa");
        var cpEmp = document.getElementById("inCodigo_postal");
        var estEmp = document.getElementById("inEstado_empresa");
        var munEmp = document.getElementById("inMunicipio_empresa");
        var ciuEmp = document.getElementById("inCiudad_empresa");
        var colEmp = document.getElementById("inColonia_empresa");
        var delEmp = document.getElementById("inDelegacion_Empresa");
        var callEmp = document.getElementById("inCalle_Empresa");
        var rfEmp = document.getElementById("inRFiscal_empresa");
        var noafiEmp = document.getElementById("inNombreAfiliacionIMSS");
        var afImss = document.getElementById("inAfiliacionIMSS");
        var riesgot = document.getElementById("inRiesgoTrabajo");
        var claserp = document.getElementById("inClase");

        $.ajax({
            url: "../Empresas/LoadEmpresa",
            type: "POST",
            data: JSON.stringify(),
            contentType: "application/json; charset=utf-8",
            success: (empresa) => {
                $(".collapse").collapse("show");
                console.log(empresa);
                nomEmp.value = empresa[1];
                nomEmpc.value = empresa[2];
                rfcemp.value = empresa[10];
                giroEmp.value = empresa[9];
                delEmp.value = empresa[6];
                callEmp.value = empresa[8];
                if (empresa[3].length < 5 ) {
                    cpEmp.value = "0" + empresa[3];
                }
                $("#btnValidaCpEstado").click();
                document.getElementById("feedback_rg").innerHTML = "<p class='text-danger'>*Para editar el Registro Patronal favor de ir al modulo de Registros Patronales</p>"
                claserp.disabled = true;
                noafiEmp.disabled = true;
                afImss.disabled = true;
                riesgot.disabled = true;
                document.getElementById("btn_saveEmpresa").classList.add("invisible");
                document.getElementById("btnClear").classList.remove("invisible");
                document.getElementById("btnUpdate").classList.remove("invisible");
                
                $("#inNombre_empresa").focus();

                $.ajax({
                    url: "../Empresas/LoadRegimenesFiscales",
                    type: "POST",
                    data: JSON.stringify(),
                    contentType: "application/json; charset=utf-8",
                    success: (regf) => {
                        console.log(regf);
                        document.getElementById("inRFiscal_empresa").innerHTML = "";
                        for (i = 0; i < regf.length; i++) {
                            if (empresa[12] == regf[i].IdRegimenFiscal) {
                                document.getElementById("inRFiscal_empresa").innerHTML += `<option selected value='${regf[i].IdRegimenFiscal}'>${regf[i].Descripcion}</option>`;
                            } else {
                                document.getElementById("inRFiscal_empresa").innerHTML += `<option value='${regf[i].IdRegimenFiscal}'>${regf[i].Descripcion}</option>`;
                            }
                        }
                    }
                });

            }
        });
        
    });
</script>


